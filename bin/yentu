#!/usr/bin/env php
<?php
error_reporting(E_ALL ^ E_NOTICE);
require "vendor/autoload.php";

$cli = new ClearIce();
$cli->addCommands('import', 'migrate', 'init', 'create', 'rollback');

$cli->addOptions(
    array(
        'command' => 'import',
        'short' => 'd',
        'long' => 'skip-defaults',
        'help' => 'do not import the default values of the columns'
    ),
    array(
        'command' => 'init',
        'short' => 'i',
        'long' => 'interractive',
        'help' => 'initialize yentu interractively'
    ),
    array(
        'command' => 'init',
        'short' => 'd',
        'long' => 'driver',
        'help' => 'database platform. Supports postgresql',
        'has_value' => true
    ),
    array(
        'command' => 'init',
        'short' => 'h',
        'long' => 'host',
        'help' => 'the hostname of the target database',
        'has_value' => true
    ),
    array(
        'command' => 'init',
        'short' => 'p',
        'long' => 'port',
        'help' => 'the port of the target database',
        'has_value' => true
    ),        
    array(
        'command' => 'init',
        'short' => 'n',
        'long' => 'dbname',
        'help' => 'the name of the target database',
        'has_value' => true
    ),        
    array(
        'command' => 'init',
        'short' => 'u',
        'long' => 'user',
        'help' => 'the user name on the target database',
        'has_value' => true
    ),        
    array(
        'command' => 'init',
        'short' => 'p',
        'long' => 'password',
        'help' => 'the passwrd of the user on the target database',
        'has_value' => true
    ),
    array(
        'short' => 'h',
        'long' => 'home',
        'help' => 'specifies where the yentu configurations are found',
        'has_value' => true
    ),
    array(
        'short' => 'v',
        'long' => 'verbose',
        'help' => 'set level of verbosity. high, mid, low and none',
        'has_value' => true
    )
);

$cli->addHelp();
$cli->setStrict(true);
$options = $cli->parse();

if(isset($options['verbose']))
{
    \yentu\Yentu::setOutputLevel($options['verbose']);
}

$welcome = <<<WELCOME
Yentu Database Migrations.
By James Ekow Abaka Ainooson

WELCOME;
\yentu\Yentu::out($welcome);

try{
    if($options['__command__'])
    {
        if($options['home']) \yentu\Yentu::setDefaultHome($options['home']);
        
        $class = "\\yentu\\commands\\" . ucfirst($options['__command__']);
        unset($options['__command__']);
        $command = new $class();
        $command->run($options);
    }
}
catch(\yentu\commands\CommandError $e)
{
    fputs(
        STDERR, 
        wordwrap("There was an error executing your command: " . $e->getMessage()) . "\n"
    );
}
catch(\yentu\DatabaseDriverException $e)
{
    fputs(
        STDERR,
        "Failed to perform database action: " . $e->getMessage() . "\n"
    );
    rollback_changes();
}

function rollback_changes()
{
    if(\yentu\ChangeLogger::getChanges() > 0)
    {
        \yentu\Yentu::out("Attempting to rollback ... ");
        $rollback = new yentu\commands\Rollback();
        $rollback->run(array());
        \yentu\Yentu::out("safely rolled back all changes.\n");
    }    
}
